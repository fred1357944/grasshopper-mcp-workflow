%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#fff', 'primaryBorderColor': '#2a5a8a', 'lineColor': '#5a5a5a', 'secondaryColor': '#f0f4f8', 'tertiaryColor': '#e8f4e8'}}}%%

flowchart TB
    subgraph HEADER["ğŸ—ï¸ GH_MCP Dual System v2.1 â€” æ··åˆæ¶æ§‹"]
        direction LR
        H1["Reference-First + Design-First + LLM Semantic Review"]
    end

    %% ç”¨æˆ¶è¼¸å…¥
    USER[/"ğŸ‘¤ ç”¨æˆ¶è«‹æ±‚<br/>ã€Œåšä¸€å€‹ WASP é›¢æ•£èšé›†ã€"/]

    %% Phase 0: Reference Search
    subgraph PHASE0["Phase 0: Reference Search"]
        direction TB
        RS_SEARCH["ğŸ” æœç´¢ Reference Library<br/>é—œéµå­—åŒ¹é… + èªç¾©ç›¸ä¼¼åº¦"]
        RS_MATCH{"ä¿¡å¿ƒåº¦ â‰¥ 0.5?"}
    end

    %% Phase 1a: Reference Confirm
    subgraph PHASE1A["Phase 1a: Reference Confirm"]
        direction TB
        RC_SHOW["ğŸ“‹ å±•ç¤ºé…ç½®æ‘˜è¦<br/>â€¢ çµ„ä»¶æ•¸é‡<br/>â€¢ é€£æ¥æ•¸é‡<br/>â€¢ lessons_learned"]
        RC_CHOICE{"ç”¨æˆ¶é¸æ“‡"}
        RC_USE["âœ… ä½¿ç”¨"]
        RC_MODIFY["ğŸ”§ ä¿®æ”¹åƒæ•¸"]
        RC_NEW["ğŸ†• é‡æ–°è¨­è¨ˆ"]
    end

    %% Phase 1b: Design-First
    subgraph PHASE1B["Phase 1b: Design-First Workflow"]
        direction TB
        DF_CLARIFY["Phase 1: CLARIFY<br/>éœ€æ±‚é‡æ¸…"]
        DF_DECOMPOSE["Phase 2: DECOMPOSE<br/>å¹¾ä½•åˆ†è§£"]
        DF_PLAN["Phase 3: PLAN<br/>çµ„ä»¶è¦åŠƒ"]
        DF_QUERY["Phase 4: QUERY<br/>GUID æŸ¥è©¢"]
    end

    %% Phase 2: Pre-Execution Check (v2.1: ç§»åˆ°èªç¾©å¯©æŸ¥å‰)
    subgraph PHASE2["Phase 2: Pre-Execution Check âš¡"]
        direction TB
        PE_SYNTAX["ğŸ“ èªæ³•é©—è­‰ (å¿«é€Ÿ)<br/>â€¢ GUID å¯ä¿¡åº¦<br/>â€¢ åƒæ•¸åé¢¨éšª<br/>â€¢ MCP å‘½ä»¤å¯ç”¨"]
        PE_RESULT{"é©—è­‰çµæœ"}
        PE_OK["âœ… é€šé"]
        PE_CRITICAL["âŒ Critical<br/>é˜»æ“‹åŸ·è¡Œ"]
    end

    %% Phase 3: Semantic Review (v2.1: åªåœ¨èªæ³•é€šéå¾ŒåŸ·è¡Œ)
    subgraph PHASE3["Phase 3: LLM Semantic Review ğŸ§ "]
        direction TB
        SR_ANALYZE["ğŸ”¬ Claude è‡ªæˆ‘å°è©±<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ è¿½è¹¤è³‡æ–™æµ<br/>â€¢ ä¼°ç®—æ¯å€‹ç¯€é»è¼¸å‡ºæ•¸é‡<br/>â€¢ è­˜åˆ¥ã€Œè³‡æ–™çˆ†ç‚¸ã€é¢¨éšª<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>ğŸ’¡ åªåœ¨èªæ³•é€šéå¾ŒåŸ·è¡Œ<br/>ï¼ˆç¯€çœ tokensï¼‰"]
        SR_CHECK{"èªç¾©æª¢æŸ¥"}
        SR_PASS["âœ… é€šé<br/>ã€Œè³‡æ–™æµæ­£å¸¸ã€"]
        SR_WARN["âš ï¸ è­¦å‘Š<br/>ã€Œæœ‰é¢¨éšªä½†å¯ç¹¼çºŒã€"]
        SR_FAIL["âŒ é˜»æ“‹<br/>ã€ŒMesh Box å°‡ç”¢ç”Ÿ<br/>6000 å€‹é¢ï¼ã€"]
        SR_CONFIRM{"ç”¨æˆ¶ç¢ºèª<br/>ã€Œé€™ç¬¦åˆæ„åœ–å—ï¼Ÿã€"}
    end

    %% Phase 4: Execute
    subgraph PHASE4["Phase 4: Execute"]
        direction TB
        EX_CLEAR["ğŸ§¹ clear_document<br/>æ¸…ç©ºç•«å¸ƒ"]
        EX_LAYOUT["ğŸ“ Smart Layout<br/>è¨ˆç®—çµ„ä»¶ä½ç½®"]
        EX_ADD["â• add_component<br/>å‰µå»ºçµ„ä»¶"]
        EX_CONNECT["ğŸ”— connect_components<br/>å»ºç«‹é€£æ¥"]
        EX_RESULT{"åŸ·è¡Œçµæœ"}
    end

    %% Phase 5: Archive & Learn
    subgraph PHASE5["Phase 5: Archive & Learn"]
        direction TB
        AL_SUCCESS["ğŸ† æˆåŠŸ<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ æå‡ confidence<br/>â€¢ é€£çºŒæˆåŠŸ 3 æ¬¡<br/>  â†’ å‡ç´š Golden"]
        AL_FAIL["ğŸ“ å¤±æ•—<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ è¨˜éŒ„ lessons_learned<br/>â€¢ é™ä½ confidence<br/>â€¢ è©¢å•é‡è©¦/æ”¾æ£„"]
    end

    %% é€£æ¥ç·š
    USER --> RS_SEARCH
    RS_SEARCH --> RS_MATCH

    RS_MATCH -->|"æœ‰åŒ¹é…"| RC_SHOW
    RS_MATCH -->|"ç„¡åŒ¹é…"| DF_CLARIFY

    RC_SHOW --> RC_CHOICE
    RC_CHOICE --> RC_USE
    RC_CHOICE --> RC_MODIFY
    RC_CHOICE --> RC_NEW

    RC_USE --> PE_SYNTAX
    RC_MODIFY --> PE_SYNTAX
    RC_NEW --> DF_CLARIFY

    DF_CLARIFY --> DF_DECOMPOSE
    DF_DECOMPOSE --> DF_PLAN
    DF_PLAN --> DF_QUERY
    DF_QUERY --> PE_SYNTAX

    PE_SYNTAX --> PE_RESULT
    PE_RESULT --> PE_OK
    PE_RESULT --> PE_CRITICAL

    PE_OK --> SR_ANALYZE
    PE_CRITICAL -->|"ä¿®å¾©å¾Œé‡è©¦"| PE_SYNTAX

    SR_ANALYZE --> SR_CHECK
    SR_CHECK --> SR_PASS
    SR_CHECK --> SR_WARN
    SR_CHECK --> SR_FAIL

    SR_PASS --> SR_CONFIRM
    SR_WARN --> SR_CONFIRM
    SR_FAIL -->|"éœ€è¦ä¿®æ”¹é…ç½®"| RC_SHOW

    SR_CONFIRM -->|"ç¢ºèª"| EX_CLEAR
    SR_CONFIRM -->|"ä¿®æ”¹"| RC_SHOW

    EX_CLEAR --> EX_LAYOUT
    EX_LAYOUT --> EX_ADD
    EX_ADD --> EX_CONNECT
    EX_CONNECT --> EX_RESULT

    EX_RESULT -->|"æˆåŠŸ"| AL_SUCCESS
    EX_RESULT -->|"å¤±æ•—"| AL_FAIL

    AL_FAIL -->|"é‡è©¦"| EX_CLEAR

    %% æ¨£å¼å®šç¾©
    classDef phaseBox fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef syntaxCheck fill:#e1f5fe,stroke:#03a9f4,stroke-width:3px
    classDef newFeature fill:#fff3e0,stroke:#ff9800,stroke-width:3px
    classDef success fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
    classDef fail fill:#ffebee,stroke:#f44336,stroke-width:2px
    classDef warning fill:#fff8e1,stroke:#ffc107,stroke-width:2px
    classDef user fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px

    class PHASE0,PHASE1A,PHASE1B,PHASE4,PHASE5 phaseBox
    class PHASE2 syntaxCheck
    class PHASE3 newFeature
    class SR_PASS,PE_OK,AL_SUCCESS,RC_USE success
    class SR_FAIL,PE_CRITICAL,AL_FAIL fail
    class SR_WARN,RC_MODIFY warning
    class USER user
