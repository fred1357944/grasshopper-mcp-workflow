%%{init: {'theme': 'base'}}%%

flowchart TB
    subgraph TITLE["üß© GH_MCP v2.0 Á≥ªÁµ±ÁµÑ‰ª∂Âúñ"]
    end

    subgraph USER_LAYER["üë§ Áî®Êà∂Â±§"]
        SKILL["/grasshopper Skill<br/>SKILL.md"]
        CLI["CLI<br/>grasshopper_tools.cli"]
    end

    subgraph WORKFLOW_LAYER["‚öôÔ∏è Â∑•‰ΩúÊµÅÁ®ãÂ±§"]
        direction TB
        EXECUTOR["WorkflowExecutor v2.0<br/>workflow_executor.py"]
        REF_FIRST["ReferenceFirstWorkflow<br/>reference_first_workflow.py"]
        DUAL_MODE["DualModeWorkflow<br/>dual_mode_workflow.py"]
    end

    subgraph SEMANTIC_LAYER["üß† Ë™ûÁæ©È©óË≠âÂ±§ (NEW!)"]
        direction LR
        VALIDATOR["SemanticValidator<br/>semantic_validator.py"]
        PROMPT_GEN["SemanticReviewPrompt<br/>semantic_review_prompt.py"]
        KNOWLEDGE["COMPONENT_BEHAVIORS<br/>Áü•Ë≠òÂ∫´"]
    end

    subgraph SYNTAX_LAYER["üìù Ë™ûÊ≥ïÈ©óË≠âÂ±§"]
        direction LR
        PRE_CHECK["PreExecutionChecker<br/>pre_execution_checker.py"]
        KB["GHKnowledgeBase<br/>knowledge_base.py"]
        TRUSTED["trusted_guids.json"]
        PATTERNS["connection_patterns.json"]
    end

    subgraph REFERENCE_LAYER["üìö ÂèÉËÄÉÂ∫´Â±§"]
        direction LR
        REF_MODE["ReferenceMode<br/>reference_mode.py"]
        METADATA["metadata.json"]
        GOLDEN["golden/<br/>cube_basic_v2.json"]
        VARIATIONS["variations/"]
    end

    subgraph EXECUTION_LAYER["üöÄ Âü∑Ë°åÂ±§"]
        direction LR
        PLACE_EXEC["PlacementExecutor<br/>placement_executor.py"]
        GH_CLIENT["GrasshopperClient<br/>client.py"]
        MCP["MCP Server<br/>GH_MCP.dll"]
    end

    subgraph GH_LAYER["ü¶ó Grasshopper"]
        RHINO["Rhino/Grasshopper"]
    end

    %% ÈÄ£Êé•
    SKILL --> EXECUTOR
    CLI --> EXECUTOR

    EXECUTOR --> REF_FIRST
    EXECUTOR --> DUAL_MODE

    REF_FIRST --> VALIDATOR
    REF_FIRST --> PRE_CHECK
    REF_FIRST --> REF_MODE

    DUAL_MODE --> PRE_CHECK
    DUAL_MODE --> REF_MODE

    VALIDATOR --> PROMPT_GEN
    VALIDATOR --> KNOWLEDGE

    PRE_CHECK --> KB
    KB --> TRUSTED
    KB --> PATTERNS

    REF_MODE --> METADATA
    METADATA --> GOLDEN
    METADATA --> VARIATIONS

    REF_FIRST --> PLACE_EXEC
    DUAL_MODE --> PLACE_EXEC

    PLACE_EXEC --> GH_CLIENT
    GH_CLIENT --> MCP
    MCP --> RHINO

    %% Ê®£Âºè
    classDef userLayer fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef workflowLayer fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef semanticLayer fill:#fff3e0,stroke:#ff9800,stroke-width:3px
    classDef syntaxLayer fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
    classDef refLayer fill:#fce4ec,stroke:#e91e63,stroke-width:2px
    classDef execLayer fill:#e1f5fe,stroke:#03a9f4,stroke-width:2px
    classDef ghLayer fill:#f5f5f5,stroke:#9e9e9e,stroke-width:2px

    class SKILL,CLI userLayer
    class EXECUTOR,REF_FIRST,DUAL_MODE workflowLayer
    class VALIDATOR,PROMPT_GEN,KNOWLEDGE semanticLayer
    class PRE_CHECK,KB,TRUSTED,PATTERNS syntaxLayer
    class REF_MODE,METADATA,GOLDEN,VARIATIONS refLayer
    class PLACE_EXEC,GH_CLIENT,MCP execLayer
    class RHINO ghLayer
