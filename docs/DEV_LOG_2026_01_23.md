# 開發日誌 2026-01-23

## 版本資訊

| 版本 | 提交 | 說明 |
|------|------|------|
| v0.2.2 | 待提交 | GHX 學習器 + Kangaroo 組件庫 |
| v0.2.1 | da99eca | 三層防護機制 + Pattern Library |
| v0.2.0 | 0ef19c1 | Design-First 互動工作流程 |

---

## 今日完成

### 1. 三層防護系統 (GUID Resolution)

**問題**: Line 組件有多個版本 (Curve vs Params)，自動搜索選錯版本導致 "Data conversion failed from Point to Line" 錯誤。

**解決方案**:
```
Layer 1: Registry 查詢 (信心度 1.0)
         ↓ 找不到
Layer 2: AI 推斷 (信心度 0.7-0.9)
         ↓ 不確定
Layer 3: 人工確認 (信心度 1.0)
```

**新增檔案**:
- `grasshopper_mcp/guid_registry.py` - 可信 GUID 註冊表
- `grasshopper_mcp/smart_resolver.py` - 三層防護解析器
- `grasshopper_mcp/auto_debugger.py` - 自動排錯系統

### 2. Pattern Library

保存 3 個設計模式：
- `industrial-bookshelf` - 工業風書架 (37 組件, 55 連接)
- `spiral-staircase-v1` - 螺旋樓梯 (4.5 ⭐)
- `parametric-table-v1` - 參數化桌子 (4.0 ⭐)

### 3. 智能部署腳本

`scripts/smart_deploy.py`:
- 整合三層防護
- 支援 `--dry-run` 驗證模式
- 自動修正參數名縮寫

### 4. GHX 學習器 (v0.2.2)

**新功能**: 從 .ghx 範例檔案自動學習組件 GUID 和參數名

**新增檔案**:
- `scripts/learn_from_ghx.py` - GHX 範例掃描器

**學習成果**:

| 來源 | 檔案數 | 組件數 | 主要類型 |
|------|--------|--------|----------|
| WASP 範例 | 39 | 142 | 聚合、材質、顏色 |
| Kangaroo 範例 | 84 | 196 | 物理模擬、Mesh 操作 |
| **合計** | **123** | **338** | - |

**Kangaroo 組件庫** (新增):
- `Spring` - 彈簧 Goal
- `Grab` - 抓取 Goal
- `Zombie Solver` / `Bouncy Solver` - 求解器
- `Non-Manifold Edges` - Mesh 邊界檢測
- `Mesh Normals` - 法向量

**關鍵發現**:
- Point 有兩個版本: `Params` (容器) vs `Vector` (構建)
- Curve、Line 同理
- Kangaroo 的 `O` 組件有多種版本 (不同求解器)

---

## LangGraph 整合分析

### 參考專案現況

路徑: `/Users/laihongyi/Downloads/grasshopper-langgraph-mcp-v2/`

| 模組 | 狀態 | 可複用性 |
|------|------|----------|
| ghx_parser.py | ✅ 完成 | 低 (我們不需要解析 .ghx) |
| pattern_extractor.py | ✅ 完成 | 中 (可參考模式識別邏輯) |
| elegance_metrics.py | ✅ 完成 | **高** (優雅度評估可直接用) |
| smart_layout.py | ✅ 完成 | **高** (佈局算法可直接用) |
| safety.py | ✅ 完成 | **高** (護欄機制可直接用) |
| mcp_integration.py | ⚠️ 模擬 | 低 (我們已有 client_optimized) |
| langgraph/ | ✅ 完成 | **待整合** |

### LangGraph 整合時機建議

用戶觀點：
> "等 Skill 跑 2-3 次教學 demo，確認流程穩定，再把「狀態機規則」抽象成 LangGraph 的 conditional edge。"

**我同意這個策略。原因：**

1. **當前 Skill 狀態機已可運作**
   - `/grasshopper` 六階段流程明確
   - File-driven state 簡單可靠
   - 人工確認點清晰

2. **LangGraph 適合的場景**
   - 需要迭代優化 (evaluate → refine 迴圈)
   - 需要多 Agent 協作
   - 需要 checkpoint/暫停/恢復

3. **現階段不需要 LangGraph 的原因**
   - 流程是線性的 (Phase 1 → 2 → 3 → 4 → 5 → 6)
   - 沒有迭代優化需求
   - 狀態簡單 (檢查檔案是否存在)

### 整合路線圖

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase A: 穩定 Skill 流程 (現在)                                  │
│  ─────────────────────────────                                   │
│  • 跑 2-3 次教學 demo                                            │
│  • 收集失敗案例和邊界情況                                          │
│  • 完善 three-layer protection                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓ 流程穩定後
┌─────────────────────────────────────────────────────────────────┐
│  Phase B: 抽象狀態機 (2-3 週後)                                   │
│  ─────────────────────────────                                   │
│  • 將 File-driven state 轉為 TypedDict                          │
│  • 識別 conditional edges (確認/修改/重來)                        │
│  • 整合 elegance_metrics.py 評估                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓ 需要迭代優化時
┌─────────────────────────────────────────────────────────────────┐
│  Phase C: 整合 LangGraph 迴圈 (1 個月後)                          │
│  ─────────────────────────────                                   │
│  • 添加 evaluate_elegance → refine 迴圈                          │
│  • 整合 safety.py 護欄                                           │
│  • 支援 checkpoint 暫停/恢復                                      │
└─────────────────────────────────────────────────────────────────┘
```

### 可立即複用的模組

從 `grasshopper-langgraph-mcp-v2` 可直接複製：

1. **elegance_metrics.py** → 評估 GH 設計的優雅度
2. **smart_layout.py** → 改善 placement_info 的佈局
3. **safety.py** → Token/迭代/成本護欄

不需要複製：
- ghx_parser.py (我們不解析 .ghx)
- mcp_integration.py (我們有 client_optimized.py)

---

## 下一步

### 近期 (本週)

1. **教學 Demo 準備**
   - 準備 3 個教學案例 (桌子、椅子、書架)
   - 測試 `/grasshopper` Skill 完整流程
   - 收集失敗案例

2. **完善文檔**
   - 更新 README.md
   - 添加使用教程

### 中期 (2 週後)

3. **整合評估模組**
   - 從 v2 複製 elegance_metrics.py
   - 在 Phase 5 後添加評估輸出

4. **教學影片**
   - 錄製完整流程 demo

---

## 問題追蹤

| ID | 問題 | 狀態 | 解決方案 |
|----|------|------|----------|
| #1 | Line Curve vs Params | ✅ 已解決 | guid_registry + category |
| #2 | 參數名縮寫不匹配 | ✅ 已解決 | auto_fix_placement_info |
| #3 | XY Plane GUID 無效 | ✅ 已解決 | 運行時查詢正確 GUID |

---

*記錄於 2026-01-23 by GH_MCP Workflow*
